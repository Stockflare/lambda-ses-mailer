# AWS Simple Email Service Lambda

The purpose of this lambda function is to receive structured payloads from an Amazon Kinesis stream, retrieve the corresponding templates from S3, render the template(s) using [Mustache.js](https://github.com/janl/mustache.js/) and then use [SES](https://aws.amazon.com/ses/) to send the email.

All templates and subject lines for emails are stored in an S3 bucket and the function itself is configuration-less. The function expects to receive Kinesis payloads similar to the following:

```
{
  "Configuration": {
    "Bucket": "my-email-templates-bucket"
  },
  "Email" : {
    "Properties": {
      "TemplateKey" : "templates/en/welcome",
      "Data" : {
        "name" : "Jeremy"
      }
    },
    "Payload": {
      "Destination": {
        "BccAddresses": [],
        "CcAddresses": [],
        "ToAddresses": ["jeremy.1234@gmail.com"]
      },
      "Source": "no-reply@example.com",
      "ReplyToAddresses": ["no-reply@example.com"]
    }
  }
}

```

### Templates

The `TemplateKey` field determines where the function will attempt to retrieve the template files from inside the configured S3 bucket (`Configuration.Bucket`), in-order to construct the email's body and subject line.

Using the example payload above, the function would expect the following files to be present:

```
s3://my-email-templates-bucket/templates/en/welcome.subj
s3://my-email-templates-bucket/templates/en/welcome.html
s3://my-email-templates-bucket/templates/en/welcome.txt
```

**Note:** The `.html` or `.txt` versions of emails are optional. However, the `.subj` is required.

0. `welcome.subj` - Determines the subject line for the email.
0. `welcome.html` - The HTML content of the email.
0. `welcome.txt` - The plain text content of the email.

All files retrieved from S3 are rendered using Mustache, with the `Email.Properties.Data` object passed into the renderer. Therefore, if `welcome.subj` contained the following content:

```
Welcome to my website, {{name}}
```

Using the example above, it would be rendered as "Welcome to my website, Jeremy". If you need more help with what mustache templates are capable of doing, be sure to checkout the [documentation](https://github.com/janl/mustache.js).

### `Payload`

The `Payload` key is the base object passed into the AWS SES `sendEmail` call. It corresponds to the documented request payload [here](http://docs.aws.amazon.com/AWSJavaScriptSDK/latest/AWS/SES.html#sendEmail-property). This makes it easy to pass in additional keys for your implementation, such as `ReturnPath` or `SourceArn`. The only object that is injected in is `Message`, which is generated by the function itself.
